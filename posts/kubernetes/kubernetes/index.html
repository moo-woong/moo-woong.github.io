<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>VMWare로 Kubernetes 설치하기 | Moo-woong</title>
<meta name=keywords content="개발환경">
<meta name=description content="VM생성 및 설정 2개 이상의 CPU Core, 2G이상의 메모리를 설정하여 VM을 생성합니다. 저는 용량이 부족해서 Kubernetes의 최소 요구사항인 2CPU, 2GMem으로 진행하였습니다. 앞으로 진행하는 절차들은 모두 모든 노드에 동일하게 진행합니다.
Guest OS에 SSH 설치 $ sudo apt-get install openssh-server Docker 설치 기본적인 설치는 Docker의 Official Installation Guide를 따릅니다.
Docker repository 설정 apt 관련 repository 설정
 $ sudo apt-get update $ sudo apt-get install \ ca-certificates \ curl \ gnupg \ lsb-release Docker의 공식 GPG Key 추가">
<meta name=author content="Me">
<link rel=canonical href=https://moo-woong.github.io/posts/kubernetes/kubernetes/>
<meta name=google-site-verification content="XYZabc">
<meta name=yandex-verification content="XYZabc">
<meta name=msvalidate.01 content="XYZabc">
<link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://moo-woong.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://moo-woong.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://moo-woong.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://moo-woong.github.io/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://moo-woong.github.io/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="VMWare로 Kubernetes 설치하기">
<meta property="og:description" content="VM생성 및 설정 2개 이상의 CPU Core, 2G이상의 메모리를 설정하여 VM을 생성합니다. 저는 용량이 부족해서 Kubernetes의 최소 요구사항인 2CPU, 2GMem으로 진행하였습니다. 앞으로 진행하는 절차들은 모두 모든 노드에 동일하게 진행합니다.
Guest OS에 SSH 설치 $ sudo apt-get install openssh-server Docker 설치 기본적인 설치는 Docker의 Official Installation Guide를 따릅니다.
Docker repository 설정 apt 관련 repository 설정
 $ sudo apt-get update $ sudo apt-get install \ ca-certificates \ curl \ gnupg \ lsb-release Docker의 공식 GPG Key 추가">
<meta property="og:type" content="article">
<meta property="og:url" content="https://moo-woong.github.io/posts/kubernetes/kubernetes/"><meta property="og:image" content="https://moo-woong.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-01-03T20:46:06+09:00">
<meta property="article:modified_time" content="2023-01-03T20:46:06+09:00"><meta property="og:site_name" content="Moo-woong's diary">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://moo-woong.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name=twitter:title content="VMWare로 Kubernetes 설치하기">
<meta name=twitter:description content="VM생성 및 설정 2개 이상의 CPU Core, 2G이상의 메모리를 설정하여 VM을 생성합니다. 저는 용량이 부족해서 Kubernetes의 최소 요구사항인 2CPU, 2GMem으로 진행하였습니다. 앞으로 진행하는 절차들은 모두 모든 노드에 동일하게 진행합니다.
Guest OS에 SSH 설치 $ sudo apt-get install openssh-server Docker 설치 기본적인 설치는 Docker의 Official Installation Guide를 따릅니다.
Docker repository 설정 apt 관련 repository 설정
 $ sudo apt-get update $ sudo apt-get install \ ca-certificates \ curl \ gnupg \ lsb-release Docker의 공식 GPG Key 추가">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://moo-woong.github.io/posts/"},{"@type":"ListItem","position":3,"name":"VMWare로 Kubernetes 설치하기","item":"https://moo-woong.github.io/posts/kubernetes/kubernetes/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"VMWare로 Kubernetes 설치하기","name":"VMWare로 Kubernetes 설치하기","description":"VM생성 및 설정 2개 이상의 CPU Core, 2G이상의 메모리를 설정하여 VM을 생성합니다. 저는 용량이 부족해서 Kubernetes의 최소 요구사항인 2CPU, 2GMem으로 진행하였습니다. 앞으로 진행하는 절차들은 모두 모든 노드에 동일하게 진행합니다.\nGuest OS에 SSH 설치 $ sudo apt-get install openssh-server Docker 설치 기본적인 설치는 Docker의 Official Installation Guide를 따릅니다.\nDocker repository 설정 apt 관련 repository 설정\n $ sudo apt-get update $ sudo apt-get install \\ ca-certificates \\ curl \\ gnupg \\ lsb-release Docker의 공식 GPG Key 추가","keywords":["개발환경"],"articleBody":"VM생성 및 설정 2개 이상의 CPU Core, 2G이상의 메모리를 설정하여 VM을 생성합니다. 저는 용량이 부족해서 Kubernetes의 최소 요구사항인 2CPU, 2GMem으로 진행하였습니다. 앞으로 진행하는 절차들은 모두 모든 노드에 동일하게 진행합니다.\nGuest OS에 SSH 설치 $ sudo apt-get install openssh-server Docker 설치 기본적인 설치는 Docker의 Official Installation Guide를 따릅니다.\nDocker repository 설정 apt 관련 repository 설정\n $ sudo apt-get update $ sudo apt-get install \\ ca-certificates \\ curl \\ gnupg \\ lsb-release Docker의 공식 GPG Key 추가\n$ sudo mkdir -p /etc/apt/keyrings $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg $ echo \\ \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\ $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list  /dev/null 추가된 Repository를 update\n$ sudo apt-get update Docker engined, containerd, docker compose 설치 $ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin Docker 설치 확인 hello-world 이미지를 다운로드 및 실행하여 Docker가 정살적으로 설치되었는지 확인\n$ sudo docker run hello-world 정상적이라면 다음처럼 hello-world:latest를 다운받고 실행됨.\nhugh@ubuntu:~$ sudo docker run hello-world Unable to find image 'hello-world:latest' locally latest: Pulling from library/hello-world 2db29710123e: Pull complete Digest: sha256:94ebc7edf3401f299cd3376a1669bc0a49aef92d6d2669005f9bc5ef028dc333 Status: Downloaded newer image for hello-world:latest Hello from Docker! This message shows that your installation appears to be working correctly. To generate this message, Docker took the following steps: 1. The Docker client contacted the Docker daemon. 2. The Docker daemon pulled the \"hello-world\" image from the Docker Hub. (amd64) 3. The Docker daemon created a new container from that image which runs the executable that produces the output you are currently reading. 4. The Docker daemon streamed that output to the Docker client, which sent it to your terminal. To try something more ambitious, you can run an Ubuntu container with: $ docker run -it ubuntu bash Share images, automate workflows, and more with a free Docker ID: https://hub.docker.com/ For more examples and ideas, visit: https://docs.docker.com/get-started/ hugh@ubuntu:~$ kubeadm, kubelet, kubectl 설치 kubernetes cluster의 필수 패키지를 설치합니다. 공식 사이트를 참조하여 설치하였습니다.\n kubeadm: 클러스터의 bootstrap 명령어\n  kubelet: 클러스터의 워커노드에서 api-server의 명령을 받아 작업을 수행하는 컴포넌트\n  kubectl: kubernetes api-server와 통신하는 CLI 유틸\n dependencies 패키지 설치 $ sudo apt-get update $ sudo apt-get install -y apt-transport-https ca-certificates curl Official GPG 키 등록 $ sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg  2023-09-10 기준, google gpg의 url이 valid하지 않습니다.\n W: GPG error: https://packages.cloud.google.com/apt kubernetes-xenial InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY B53DC80D13EDEF05 E: The repository 'https://apt.kubernetes.io kubernetes-xenial InRelease' is not signed. N: Updating from such a repository can't be done securely, and is therefore disabled by default. N: See apt-secure(8) manpage for repository creation and user configuration details. 다음의 주소로 사용해보세요.\nsudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://dl.k8s.io/apt/doc/apt-key.gpg $ echo \"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main\" | sudo tee /etc/apt/sources.list.d/kubernetes.list apt index 업데이트 및 패키지 설치 $ sudo apt-get update $ sudo apt-get install -y kubelet kubeadm kubectl $ sudo apt-mark hold kubelet kubeadm kubectl cgroup 드라이버 설정 컨테이너 런타임, kubelet의 cgroup driver를 일치시켜야 하며, 일치하지 않을 경우 kubelet 프로세스에서 오류가 발생하므로 일치시켜주는 작업을 진행합니다. cgroup driver는 cgroupfs와 systemd가 있으며 kubelet v1.21.0 이상부터는 systemd가 기본입니다. 우리가 사용하는 컨테이너 런타임은 Docker 이므로 Docker의 cgroup을 cgroupfs 에서 systemd로 변경하도록 합니다.\n cgroup은 리눅스에서 프로세스에 할당된 리소스를 격리하고 제한하는데 사용합니다. kubelet은 자원관리를 위해 cgroup을 사용합니다.\n Docker의 cgroup 드라이버 확인\nhugh@ubuntu:~$ sudo docker info | grep Cgroup Cgroup Driver: cgroupfs Cgroup Version: 1 Docker service 설정파일 변경\nUbuntu에서 정상적으로 docker를 설치했다면 다음의 경로의 파일이 존재합니다.\n /usr/lib/systemd/system/docker.service  해당 파일의 ExecStart변수를 다음과 같이 수정해주세요.\n수정 전\nExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock 수정 후\nExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd daemon 리로드 및 docker service를 재시작\n$ systemctl daemon-reload $ systemctl restart docker docker의 cgroup 확인\nhugh@ubuntu:~$ sudo docker info | grep Cgroup Cgroup Driver: systemd Cgroup Version: 1 swap 설정 off kubernetes에서는 최대한의 자원을 활용하게 하므로 worker node의 리소스를 최대한 사용합니다. swap이 발생할 경우 속도 저하가 발생합니다. 또한 kubelet이 swap에 대해 고려하지 않습니다. 따라서 모든 노드들에 swap을 off합니다.\n$ sudo swapoff -a 부팅 시 swapoff를 위해 /etc/fstab을 수정합니다.\n$ sudo sed -i '/ swap / s/^\\(.*\\)$/#\\1/g' /etc/fstab hostname 변경 및 /etc/hosts 등록 kubernetes의 hostname은 고유해야 합니다. 이를 위해서 master 노드와 worker 노드의 hostname을 변경해야합니다. 저는 master 노드와 worker 노드 3대로 이루어져 있어서 다음과 같이 구성하였습니다.\nmaster worker1 worker2 worker3 각 노드에서 알맞은 hostname으로 변경\n$ sudo hostnamectl set-hostname  /etc/hosts에서 localhost의 hostname을 변경\n127.0.0.1 localhost 127.0.1.1 master # master node 설정 마스터노드의 설정을 진행합니다.\n$ sudo kubeadm init \"Status from runtime service failed\" 오류가 발생할 수 있습니다.\nhugh@master:~$ sudo kubeadm init --pod-network-cidr 192.168.0.0/16 [sudo] password for hugh: [init] Using Kubernetes version: v1.26.0 [preflight] Running pre-flight checks error execution phase preflight: [preflight] Some fatal errors occurred: [ERROR CRI]: container runtime is not running: output: E0103 20:21:46.201539 1806 remote_runtime.go:948] \"Status from runtime service failed\" err=\"rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService\" time=\"2023-01-03T20:21:46-08:00\" level=fatal msg=\"getting status of runtime: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService\" , error: exit status 1 [preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...` To see the stack trace of this error execute with --v=5 or higher  --pod-network-cidr subnet은 이 cluster에서 생성되는 Pod들의 network를 명시하는 설정입니다. --pod-network-cidr는 calico CNI를 설치할때 default로 사용되는 subnet이라서 해당 subnet을 사용하도록 명시하였습니다.  위와 같이 오류가 발생한다면 초기화를 진행해주세요.\n$ sudo rm /etc/containerd/config.toml $ sudo systemctl restart containerd 이후 다시 kubeadm init을 실행하여 성공적으로 진행되었는지 확인합니다.\n...OMMITTED... [addons] Applied essential addon: kube-proxy Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Alternatively, if you are the root user, you can run: export KUBECONFIG=/etc/kubernetes/admin.conf You should now deploy a pod network to the cluster. Run \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: kubeadm join 192.168.83.134:6443 --token zifa73.5r6d1i6a0ouptd9c \\ --discovery-token-ca-cert-hash sha256:9dd31647a596dfb748d6f5c1a6def414b9e13f51041782c6872fde6921f11859 hugh@master:~$  여기까지 진행했는데 master노드의 용량이 부족했습니다. 처음에 10G로 잡았는데… 너무 욕심이었네요, 20G로 VM의 사이즈를 늘리고 계속 진행했습니다.\n kubeadm init을 완료하면 위 로그에서 나오는것 처럼 master 노드에서 진행할 추가 작업을 안내합니다.\nTo start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config 해당 절차를 진행합니다.\n또한 worker 노드에서 kubeadm join을 수행하라고 안내가 나타납니다. 이제 worker 노드에서 join을 합니다.\nworker 노드 설정 kubeadm init에서 안내된 내용대로 worker 노드를 master 노드에 join 합니다.\n 해당 내용은 master node의 IP에 따라 다르므로 알맞게 설정합니다.\n $ kubeadm join 192.168.83.134:6443 --token zifa73.5r6d1i6a0ouptd9c \\ --discovery-token-ca-cert-hash sha256:9dd31647a596dfb748d6f5c1a6def414b9e13f51041782c6872fde6921f11859 워커 노드에서 명령어 실행 시 kubeadm init에서 발생한 에러가 동일하게 나타날 수 있습니다. master 노드에서 진행한 동일한 커맨드로 containerd를 재시작 후 join을 수행합니다.\n다음과 같이 로그나 나오면 정상적으로 join이 된것입니다.\nThis node has joined the cluster: * Certificate signing request was sent to apiserver and a response was received. * The Kubelet was informed of the new secure connection details. Run 'kubectl get nodes' on the control-plane to see this node join the cluster. 네트워크 구성 마스터 노드와 워커노드의 환경설정을 완료했습니다. 마스터 노드에서 kubectl get no를 통해서 nodes들의 상태를 확인해봅니다.\nhugh@master:~$ kubectl get nodes NAME STATUS ROLES AGE VERSION master NotReady control-plane 21m v1.26.0 worker1 NotReady  3m11s v1.26.0 worker2 NotReady  62s v1.26.0 worker3 NotReady  57s v1.26.0 마스터 노드는 worker노드들의 존재를 알지만 STATUS가 NotReady입니다. 이는 pod network가 현재 deploy된 상태가 아니기 때문입니다. pod network를 설치해봅니다.\n다양한 CNI(Container Network Interface)가 있지만, 저는 calico를 설치해보겠습니다.\nCalico 설정파일 다운로드\nhugh@master:~$ cd ~/calico/ hugh@master:~/calico$ curl https://projectcalico.docs.tigera.io/manifests/calico.yaml -O  calico 주소는 변경될 수 있습니다. 2023-09-10 기준으로는 https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml 로 redirect 되므로, 변경된 주소로 사용해야 합니다.\n Calico CNI 설치\nhugh@master:~/calico$ kubectl apply -f calico.yaml poddisruptionbudget.policy/calico-kube-controllers created serviceaccount/calico-kube-controllers created serviceaccount/calico-node created configmap/calico-config created customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created clusterrole.rbac.authorization.k8s.io/calico-node created clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created clusterrolebinding.rbac.authorization.k8s.io/calico-node created daemonset.apps/calico-node created deployment.apps/calico-kube-controllers created 정상설치 되었다면 calico관련 pod들이 Running status인것을 확인할 수 있습니다.\nhugh@master:~/calico$ kubectl get po -A NAMESPACE NAME READY STATUS RESTARTS AGE kube-system calico-kube-controllers-57b57c56f-bmcnw 1/1 Running 0 105s kube-system calico-node-djvgt 1/1 Running 0 105s kube-system calico-node-g9bcp 1/1 Running 0 105s kube-system calico-node-hdwtj 1/1 Running 0 105s kube-system calico-node-nhdpq 1/1 Running 0 105s kube-system coredns-787d4945fb-9vcsv 1/1 Running 0 9m30s kube-system coredns-787d4945fb-kxtsk 1/1 Running 0 9m30s kube-system etcd-master 1/1 Running 24 9m44s kube-system kube-apiserver-master 1/1 Running 0 9m45s kube-system kube-controller-manager-master 1/1 Running 0 9m46s kube-system kube-proxy-9zkvx 1/1 Running 0 2m29s kube-system kube-proxy-lkdk6 1/1 Running 0 9m30s kube-system kube-proxy-nc56s 1/1 Running 0 4m34s kube-system kube-proxy-tw5xc 1/1 Running 0 3m14s kube-system kube-scheduler-master 1/1 Running 0 9m44s 설치 후 node들이 정상적으로 Ready 상태로 변경된걸 확인할 수 있습니다.\n$ kubectl get no NAME STATUS ROLES AGE VERSION master Ready control-plane 40m v1.26.0 worker1 Ready  21m v1.26.0 worker2 Ready  19m v1.26.0 worker3 Ready  19m v1.26.0 동작 확인 kubernetes 관련 컴포넌트, 마스터 및 워커노드 설정이 완료되었습니다. 임의의 pod를 설치하여 정상적으로 동작하는지 확인해보겠습니다.\nDeployment 설치 $ kubectl create deployment nginx --image=nginx NodePort Service 설치 $ kubectl expose deployment nginx --type=NodePort --port=80 --target-port=80 $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1  443/TCP 43m nginx NodePort 10.106.136.69  80:30910/TCP 8s Master 노드를 통해 nginx 서비스 접근 확인   ","wordCount":"1541","inLanguage":"en","datePublished":"2023-01-03T20:46:06+09:00","dateModified":"2023-01-03T20:46:06+09:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://moo-woong.github.io/posts/kubernetes/kubernetes/"},"publisher":{"@type":"Organization","name":"Moo-woong","logo":{"@type":"ImageObject","url":"https://moo-woong.github.io/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://moo-woong.github.io accesskey=h title="Home (Alt + H)">
<img src=https://moo-woong.github.io/apple-touch-icon.png alt aria-label=logo height=35>Home</a>
<div class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</div>
</div>
<ul id=menu>
<li>
<a href=https://moo-woong.github.io/categories/ title=categories>
<span>categories</span>
</a>
</li>
<li>
<a href=https://moo-woong.github.io/tags/ title=tags>
<span>tags</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://moo-woong.github.io>Home</a>&nbsp;»&nbsp;<a href=https://moo-woong.github.io/posts/>Posts</a></div>
<h1 class=post-title>
VMWare로 Kubernetes 설치하기
</h1>
<div class=post-meta><span title="2023-01-03 20:46:06 +0900 KST">January 3, 2023</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;1541 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/kubernetes/kubernetes.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details open>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><nav id=TableOfContents>
<ul>
<li><a href=#vm생성-및-설정>VM생성 및 설정</a></li>
<li><a href=#guest-os에-ssh-설치>Guest OS에 SSH 설치</a></li>
<li><a href=#docker-설치>Docker 설치</a>
<ul>
<li><a href=#docker-repository-설정>Docker repository 설정</a></li>
<li><a href=#docker-engined-containerd-docker-compose-설치>Docker engined, containerd, docker compose 설치</a></li>
<li><a href=#docker-설치-확인>Docker 설치 확인</a></li>
</ul>
</li>
<li><a href=#kubeadm-kubelet-kubectl-설치>kubeadm, kubelet, kubectl 설치</a>
<ul>
<li><a href=#dependencies-패키지-설치>dependencies 패키지 설치</a></li>
<li><a href=#official-gpg-키-등록>Official GPG 키 등록</a></li>
<li><a href=#apt-index-업데이트-및-패키지-설치>apt index 업데이트 및 패키지 설치</a></li>
<li><a href=#cgroup-드라이버-설정>cgroup 드라이버 설정</a></li>
</ul>
</li>
<li><a href=#swap-설정-off>swap 설정 off</a></li>
<li><a href=#hostname-변경-및-etchosts-등록>hostname 변경 및 /etc/hosts 등록</a></li>
<li><a href=#master-node-설정>master node 설정</a></li>
<li><a href=#worker-노드-설정>worker 노드 설정</a></li>
<li><a href=#네트워크-구성>네트워크 구성</a></li>
<li><a href=#동작-확인>동작 확인</a>
<ul>
<li><a href=#deployment-설치>Deployment 설치</a></li>
<li><a href=#nodeport-service-설치>NodePort Service 설치</a></li>
<li><a href=#master-노드를-통해-nginx-서비스-접근-확인>Master 노드를 통해 nginx 서비스 접근 확인</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</details>
</div>
<div class=post-content><h2 id=vm생성-및-설정>VM생성 및 설정<a hidden class=anchor aria-hidden=true href=#vm생성-및-설정>#</a></h2>
<p>2개 이상의 CPU Core, 2G이상의 메모리를 설정하여 VM을 생성합니다.
저는 용량이 부족해서 Kubernetes의 최소 요구사항인 2CPU, 2GMem으로 진행하였습니다.
앞으로 진행하는 절차들은 모두 모든 노드에 동일하게 진행합니다.</p>
<h2 id=guest-os에-ssh-설치>Guest OS에 SSH 설치<a hidden class=anchor aria-hidden=true href=#guest-os에-ssh-설치>#</a></h2>
<pre tabindex=0><code>$ sudo apt-get install openssh-server
</code></pre><h2 id=docker-설치>Docker 설치<a hidden class=anchor aria-hidden=true href=#docker-설치>#</a></h2>
<p>기본적인 설치는 <code>Docker</code>의 Official <a href=https://docs.docker.com/engine/install/ubuntu/>Installation Guide</a>를 따릅니다.</p>
<h3 id=docker-repository-설정>Docker repository 설정<a hidden class=anchor aria-hidden=true href=#docker-repository-설정>#</a></h3>
<p><code>apt</code> 관련 repository 설정</p>
<pre tabindex=0><code> $ sudo apt-get update

 $ sudo apt-get install \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
</code></pre><p><code>Docker</code>의 공식 GPG Key 추가</p>
<pre tabindex=0><code>$ sudo mkdir -p /etc/apt/keyrings

$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

$ echo \
  &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable&quot; | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</code></pre><p>추가된 Repository를 update</p>
<pre tabindex=0><code>$ sudo apt-get update
</code></pre><h3 id=docker-engined-containerd-docker-compose-설치>Docker engined, containerd, docker compose 설치<a hidden class=anchor aria-hidden=true href=#docker-engined-containerd-docker-compose-설치>#</a></h3>
<pre tabindex=0><code>$ sudo apt-get install docker-ce docker-ce-cli containerd.io docker-compose-plugin
</code></pre><h3 id=docker-설치-확인>Docker 설치 확인<a hidden class=anchor aria-hidden=true href=#docker-설치-확인>#</a></h3>
<p>hello-world 이미지를 다운로드 및 실행하여 Docker가 정살적으로 설치되었는지 확인</p>
<pre tabindex=0><code>$ sudo docker run hello-world
</code></pre><p>정상적이라면 다음처럼 hello-world:latest를 다운받고 실행됨.</p>
<pre tabindex=0><code>hugh@ubuntu:~$ sudo docker run hello-world
Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
2db29710123e: Pull complete 
Digest: sha256:94ebc7edf3401f299cd3376a1669bc0a49aef92d6d2669005f9bc5ef028dc333
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/

hugh@ubuntu:~$ 
</code></pre><h2 id=kubeadm-kubelet-kubectl-설치>kubeadm, kubelet, kubectl 설치<a hidden class=anchor aria-hidden=true href=#kubeadm-kubelet-kubectl-설치>#</a></h2>
<p>kubernetes cluster의 필수 패키지를 설치합니다. <a href=https://kubernetes.io/ko/docs/setup/production-environment/tools/kubeadm/install-kubeadm/>공식 사이트</a>를 참조하여 설치하였습니다.</p>
<blockquote>
<p>kubeadm: 클러스터의 bootstrap 명령어</p>
</blockquote>
<blockquote>
<p>kubelet: 클러스터의 워커노드에서 api-server의 명령을 받아 작업을 수행하는 컴포넌트</p>
</blockquote>
<blockquote>
<p>kubectl: kubernetes api-server와 통신하는 CLI 유틸</p>
</blockquote>
<h3 id=dependencies-패키지-설치>dependencies 패키지 설치<a hidden class=anchor aria-hidden=true href=#dependencies-패키지-설치>#</a></h3>
<pre tabindex=0><code>$ sudo apt-get update
$ sudo apt-get install -y apt-transport-https ca-certificates curl
</code></pre><h3 id=official-gpg-키-등록>Official GPG 키 등록<a hidden class=anchor aria-hidden=true href=#official-gpg-키-등록>#</a></h3>
<pre tabindex=0><code>$ sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
</code></pre><blockquote>
<p>2023-09-10 기준, google gpg의 url이 valid하지 않습니다.</p>
</blockquote>
<pre tabindex=0><code>W: GPG error: https://packages.cloud.google.com/apt kubernetes-xenial InRelease: The following signatures couldn't be verified because the public key is not available: NO_PUBKEY B53DC80D13EDEF05
E: The repository 'https://apt.kubernetes.io kubernetes-xenial InRelease' is not signed.
N: Updating from such a repository can't be done securely, and is therefore disabled by default.
N: See apt-secure(8) manpage for repository creation and user configuration details.
</code></pre><p>다음의 주소로 사용해보세요.</p>
<pre tabindex=0><code>sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://dl.k8s.io/apt/doc/apt-key.gpg
</code></pre><pre tabindex=0><code>$ echo &quot;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot; | sudo tee /etc/apt/sources.list.d/kubernetes.list
</code></pre><h3 id=apt-index-업데이트-및-패키지-설치>apt index 업데이트 및 패키지 설치<a hidden class=anchor aria-hidden=true href=#apt-index-업데이트-및-패키지-설치>#</a></h3>
<pre tabindex=0><code>$ sudo apt-get update
$ sudo apt-get install -y kubelet kubeadm kubectl
$ sudo apt-mark hold kubelet kubeadm kubectl
</code></pre><h3 id=cgroup-드라이버-설정>cgroup 드라이버 설정<a hidden class=anchor aria-hidden=true href=#cgroup-드라이버-설정>#</a></h3>
<p>컨테이너 런타임, kubelet의 cgroup driver를 일치시켜야 하며, 일치하지 않을 경우 kubelet 프로세스에서 오류가 발생하므로 일치시켜주는 작업을 진행합니다. cgroup driver는 <code>cgroupfs</code>와 <code>systemd</code>가 있으며 kubelet v1.21.0 이상부터는 <code>systemd</code>가 기본입니다. 우리가 사용하는 컨테이너 런타임은 <code>Docker</code> 이므로 <code>Docker</code>의 cgroup을 <code>cgroupfs</code> 에서 <code>systemd</code>로 변경하도록 합니다.</p>
<blockquote>
<p>cgroup은 리눅스에서 프로세스에 할당된 리소스를 격리하고 제한하는데 사용합니다. <code>kubelet</code>은 자원관리를 위해 cgroup을 사용합니다.</p>
</blockquote>
<p>Docker의 cgroup 드라이버 확인</p>
<pre tabindex=0><code>hugh@ubuntu:~$ sudo docker info | grep Cgroup
 Cgroup Driver: cgroupfs
 Cgroup Version: 1
</code></pre><p>Docker service 설정파일 변경</p>
<p>Ubuntu에서 정상적으로 docker를 설치했다면 다음의 경로의 파일이 존재합니다.</p>
<ul>
<li><code>/usr/lib/systemd/system/docker.service</code></li>
</ul>
<p>해당 파일의 <code>ExecStart</code>변수를 다음과 같이 수정해주세요.</p>
<p>수정 전</p>
<pre tabindex=0><code>ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
</code></pre><p>수정 후</p>
<pre tabindex=0><code>ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd
</code></pre><p>daemon 리로드 및 docker service를 재시작</p>
<pre tabindex=0><code>$ systemctl daemon-reload 
$ systemctl restart docker
</code></pre><p>docker의 cgroup 확인</p>
<pre tabindex=0><code>hugh@ubuntu:~$ sudo docker info | grep Cgroup
 Cgroup Driver: systemd
 Cgroup Version: 1
</code></pre><h2 id=swap-설정-off>swap 설정 off<a hidden class=anchor aria-hidden=true href=#swap-설정-off>#</a></h2>
<p>kubernetes에서는 최대한의 자원을 활용하게 하므로 worker node의 리소스를 최대한 사용합니다. swap이 발생할 경우 속도 저하가 발생합니다. 또한 <code>kubelet</code>이 swap에 대해 고려하지 않습니다. 따라서 모든 노드들에 swap을 off합니다.</p>
<pre tabindex=0><code>$ sudo swapoff -a
</code></pre><p>부팅 시 swapoff를 위해 <code>/etc/fstab</code>을 수정합니다.</p>
<pre tabindex=0><code>$ sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
</code></pre><h2 id=hostname-변경-및-etchosts-등록>hostname 변경 및 /etc/hosts 등록<a hidden class=anchor aria-hidden=true href=#hostname-변경-및-etchosts-등록>#</a></h2>
<p>kubernetes의 hostname은 고유해야 합니다. 이를 위해서 master 노드와 worker 노드의 hostname을 변경해야합니다. 저는 master 노드와 worker 노드 3대로 이루어져 있어서 다음과 같이 구성하였습니다.</p>
<pre tabindex=0><code>master
worker1
worker2
worker3
</code></pre><p>각 노드에서 알맞은 hostname으로 변경</p>
<pre tabindex=0><code>$ sudo hostnamectl set-hostname &lt;노드명&gt;
</code></pre><p><code>/etc/hosts</code>에서 localhost의 hostname을 변경</p>
<pre tabindex=0><code>127.0.0.1       localhost
127.0.1.1       master # &lt;-- 변경부분

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
</code></pre><h2 id=master-node-설정>master node 설정<a hidden class=anchor aria-hidden=true href=#master-node-설정>#</a></h2>
<p>마스터노드의 설정을 진행합니다.</p>
<pre tabindex=0><code>$ sudo kubeadm init
</code></pre><p><code>"Status from runtime service failed"</code> 오류가 발생할 수 있습니다.</p>
<pre tabindex=0><code>hugh@master:~$ sudo kubeadm init --pod-network-cidr 192.168.0.0/16
[sudo] password for hugh: 
[init] Using Kubernetes version: v1.26.0
[preflight] Running pre-flight checks
error execution phase preflight: [preflight] Some fatal errors occurred:
	[ERROR CRI]: container runtime is not running: output: E0103 20:21:46.201539    1806 remote_runtime.go:948] &quot;Status from runtime service failed&quot; err=&quot;rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService&quot;
time=&quot;2023-01-03T20:21:46-08:00&quot; level=fatal msg=&quot;getting status of runtime: rpc error: code = Unimplemented desc = unknown service runtime.v1alpha2.RuntimeService&quot;
, error: exit status 1
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
To see the stack trace of this error execute with --v=5 or higher
</code></pre><ul>
<li><code>--pod-network-cidr</code> subnet은 이 cluster에서 생성되는 Pod들의 network를 명시하는 설정입니다.</li>
<li><code>--pod-network-cidr</code>는 <code>calico</code> CNI를 설치할때 default로 사용되는 subnet이라서 해당 subnet을 사용하도록 명시하였습니다.</li>
</ul>
<p>위와 같이 오류가 발생한다면 초기화를 진행해주세요.</p>
<pre tabindex=0><code>$ sudo rm /etc/containerd/config.toml
$ sudo systemctl restart containerd
</code></pre><p>이후 다시 <code>kubeadm init</code>을 실행하여 성공적으로 진행되었는지 확인합니다.</p>
<pre tabindex=0><code>...OMMITTED...

[addons] Applied essential addon: kube-proxy

Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.83.134:6443 --token zifa73.5r6d1i6a0ouptd9c \
	--discovery-token-ca-cert-hash sha256:9dd31647a596dfb748d6f5c1a6def414b9e13f51041782c6872fde6921f11859 
hugh@master:~$
</code></pre><blockquote>
<p>여기까지 진행했는데 <code>master</code>노드의 용량이 부족했습니다. 처음에 10G로 잡았는데&mldr; 너무 욕심이었네요, 20G로 VM의 사이즈를 늘리고 계속 진행했습니다.</p>
</blockquote>
<p><code>kubeadm init</code>을 완료하면 위 로그에서 나오는것 처럼 master 노드에서 진행할 추가 작업을 안내합니다.</p>
<pre tabindex=0><code>To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre><p>해당 절차를 진행합니다.</p>
<p>또한 worker 노드에서 <code>kubeadm join</code>을 수행하라고 안내가 나타납니다. 이제 worker 노드에서 <code>join</code>을 합니다.</p>
<h2 id=worker-노드-설정>worker 노드 설정<a hidden class=anchor aria-hidden=true href=#worker-노드-설정>#</a></h2>
<p><code>kubeadm init</code>에서 안내된 내용대로 worker 노드를 master 노드에 join 합니다.</p>
<blockquote>
<p>해당 내용은 master node의 IP에 따라 다르므로 알맞게 설정합니다.</p>
</blockquote>
<pre tabindex=0><code>$ kubeadm join 192.168.83.134:6443 --token zifa73.5r6d1i6a0ouptd9c \
	--discovery-token-ca-cert-hash sha256:9dd31647a596dfb748d6f5c1a6def414b9e13f51041782c6872fde6921f11859 
</code></pre><p>워커 노드에서 명령어 실행 시 <code>kubeadm init</code>에서 발생한 에러가 동일하게 나타날 수 있습니다. master 노드에서 진행한 동일한 커맨드로 containerd를 재시작 후 join을 수행합니다.</p>
<p>다음과 같이 로그나 나오면 정상적으로 join이 된것입니다.</p>
<pre tabindex=0><code>This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
</code></pre><h2 id=네트워크-구성>네트워크 구성<a hidden class=anchor aria-hidden=true href=#네트워크-구성>#</a></h2>
<p>마스터 노드와 워커노드의 환경설정을 완료했습니다. 마스터 노드에서 <code>kubectl get no</code>를 통해서 nodes들의 상태를 확인해봅니다.</p>
<pre tabindex=0><code>hugh@master:~$ kubectl get nodes
NAME      STATUS     ROLES           AGE     VERSION
master    NotReady   control-plane   21m     v1.26.0
worker1   NotReady   &lt;none&gt;          3m11s   v1.26.0
worker2   NotReady   &lt;none&gt;          62s     v1.26.0
worker3   NotReady   &lt;none&gt;          57s     v1.26.0
</code></pre><p>마스터 노드는 worker노드들의 존재를 알지만 STATUS가 NotReady입니다. 이는 pod network가 현재 deploy된 상태가 아니기 때문입니다.
pod network를 설치해봅니다.</p>
<p>다양한 <code>CNI(Container Network Interface)</code>가 있지만, 저는 <code>calico</code>를 설치해보겠습니다.</p>
<p>Calico 설정파일 다운로드</p>
<pre tabindex=0><code>hugh@master:~$ cd ~/calico/
hugh@master:~/calico$ curl https://projectcalico.docs.tigera.io/manifests/calico.yaml -O
</code></pre><blockquote>
<p>calico 주소는 변경될 수 있습니다. 2023-09-10 기준으로는 <a href=https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml>https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml</a> 로 redirect 되므로, 변경된 주소로 사용해야 합니다.</p>
</blockquote>
<p>Calico CNI 설치</p>
<pre tabindex=0><code>hugh@master:~/calico$ kubectl apply -f calico.yaml 
poddisruptionbudget.policy/calico-kube-controllers created
serviceaccount/calico-kube-controllers created
serviceaccount/calico-node created
configmap/calico-config created
customresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/caliconodestatuses.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/ipreservations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created
customresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created
clusterrole.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrole.rbac.authorization.k8s.io/calico-node created
clusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created
clusterrolebinding.rbac.authorization.k8s.io/calico-node created
daemonset.apps/calico-node created
deployment.apps/calico-kube-controllers created
</code></pre><p>정상설치 되었다면 calico관련 pod들이 Running status인것을 확인할 수 있습니다.</p>
<pre tabindex=0><code>hugh@master:~/calico$ kubectl get po -A
NAMESPACE     NAME                                      READY   STATUS    RESTARTS   AGE
kube-system   calico-kube-controllers-57b57c56f-bmcnw   1/1     Running   0          105s
kube-system   calico-node-djvgt                         1/1     Running   0          105s
kube-system   calico-node-g9bcp                         1/1     Running   0          105s
kube-system   calico-node-hdwtj                         1/1     Running   0          105s
kube-system   calico-node-nhdpq                         1/1     Running   0          105s
kube-system   coredns-787d4945fb-9vcsv                  1/1     Running   0          9m30s
kube-system   coredns-787d4945fb-kxtsk                  1/1     Running   0          9m30s
kube-system   etcd-master                               1/1     Running   24         9m44s
kube-system   kube-apiserver-master                     1/1     Running   0          9m45s
kube-system   kube-controller-manager-master            1/1     Running   0          9m46s
kube-system   kube-proxy-9zkvx                          1/1     Running   0          2m29s
kube-system   kube-proxy-lkdk6                          1/1     Running   0          9m30s
kube-system   kube-proxy-nc56s                          1/1     Running   0          4m34s
kube-system   kube-proxy-tw5xc                          1/1     Running   0          3m14s
kube-system   kube-scheduler-master                     1/1     Running   0          9m44s
</code></pre><p>설치 후 node들이 정상적으로 Ready 상태로 변경된걸 확인할 수 있습니다.</p>
<pre tabindex=0><code>$ kubectl get no
NAME      STATUS   ROLES           AGE   VERSION
master    Ready    control-plane   40m   v1.26.0
worker1   Ready    &lt;none&gt;          21m   v1.26.0
worker2   Ready    &lt;none&gt;          19m   v1.26.0
worker3   Ready    &lt;none&gt;          19m   v1.26.0
</code></pre><h2 id=동작-확인>동작 확인<a hidden class=anchor aria-hidden=true href=#동작-확인>#</a></h2>
<p>kubernetes 관련 컴포넌트, 마스터 및 워커노드 설정이 완료되었습니다. 임의의 pod를 설치하여 정상적으로 동작하는지 확인해보겠습니다.</p>
<h3 id=deployment-설치>Deployment 설치<a hidden class=anchor aria-hidden=true href=#deployment-설치>#</a></h3>
<pre tabindex=0><code>$ kubectl create deployment nginx --image=nginx
</code></pre><h3 id=nodeport-service-설치>NodePort Service 설치<a hidden class=anchor aria-hidden=true href=#nodeport-service-설치>#</a></h3>
<pre tabindex=0><code>$ kubectl expose deployment nginx --type=NodePort --port=80 --target-port=80

$ kubectl get svc
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP        43m
nginx        NodePort    10.106.136.69   &lt;none&gt;        80:30910/TCP   8s
</code></pre><h3 id=master-노드를-통해-nginx-서비스-접근-확인>Master 노드를 통해 nginx 서비스 접근 확인<a hidden class=anchor aria-hidden=true href=#master-노드를-통해-nginx-서비스-접근-확인>#</a></h3>
<figure>
<img loading=lazy src=/images/kubernetes/nginx_access.png>
</figure>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://moo-woong.github.io/tags/%EA%B0%9C%EB%B0%9C%ED%99%98%EA%B2%BD/>개발환경</a></li>
</ul>
<nav class=paginav>
<a class=prev href=https://moo-woong.github.io/posts/dev_env/sudoers_permission/>
<span class=title>« Prev</span>
<br>
<span>[Dev/Infra] XXX is not in the sudoers file. This incident will be reported.</span>
</a>
<a class=next href=https://moo-woong.github.io/posts/algorithm/algo_83_remove_duplicates_from_sorted_list/>
<span class=title>Next »</span>
<br>
<span>LeetCode 공부 - Remove Duplicates from Sorted List</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share VMWare로 Kubernetes 설치하기 on twitter" href="https://twitter.com/intent/tweet/?text=VMWare%eb%a1%9c%20Kubernetes%20%ec%84%a4%ec%b9%98%ed%95%98%ea%b8%b0&url=https%3a%2f%2fmoo-woong.github.io%2fposts%2fkubernetes%2fkubernetes%2f&hashtags=%ea%b0%9c%eb%b0%9c%ed%99%98%ea%b2%bd"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share VMWare로 Kubernetes 설치하기 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fmoo-woong.github.io%2fposts%2fkubernetes%2fkubernetes%2f&title=VMWare%eb%a1%9c%20Kubernetes%20%ec%84%a4%ec%b9%98%ed%95%98%ea%b8%b0&summary=VMWare%eb%a1%9c%20Kubernetes%20%ec%84%a4%ec%b9%98%ed%95%98%ea%b8%b0&source=https%3a%2f%2fmoo-woong.github.io%2fposts%2fkubernetes%2fkubernetes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share VMWare로 Kubernetes 설치하기 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fmoo-woong.github.io%2fposts%2fkubernetes%2fkubernetes%2f&title=VMWare%eb%a1%9c%20Kubernetes%20%ec%84%a4%ec%b9%98%ed%95%98%ea%b8%b0"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share VMWare로 Kubernetes 설치하기 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmoo-woong.github.io%2fposts%2fkubernetes%2fkubernetes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share VMWare로 Kubernetes 설치하기 on whatsapp" href="https://api.whatsapp.com/send?text=VMWare%eb%a1%9c%20Kubernetes%20%ec%84%a4%ec%b9%98%ed%95%98%ea%b8%b0%20-%20https%3a%2f%2fmoo-woong.github.io%2fposts%2fkubernetes%2fkubernetes%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label="share VMWare로 Kubernetes 설치하기 on telegram" href="https://telegram.me/share/url?text=VMWare%eb%a1%9c%20Kubernetes%20%ec%84%a4%ec%b9%98%ed%95%98%ea%b8%b0&url=https%3a%2f%2fmoo-woong.github.io%2fposts%2fkubernetes%2fkubernetes%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2024 <a href=https://moo-woong.github.io>Moo-woong</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
</body>
</html>